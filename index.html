<script>
(function () {
  "use strict";

  // ===== 0) 안전 가드: 요소 없으면 JS 중단 대신 안내만 띄우고 종료(흰화면 방지) =====
  const form   = document.getElementById("delegation-form");
  const canvas = document.getElementById("signature-canvas");

  if (!form || !canvas) {
    const msg = document.createElement("div");
    msg.style.cssText = "margin:12px;padding:10px;border:2px solid #c0392b;border-radius:10px;background:#fff0f0;color:#c0392b;font-weight:600;";
    msg.textContent = "요소를 찾지 못했습니다. id 확인 필요: delegation-form / signature-canvas";
    document.body.insertBefore(msg, document.body.firstChild);
    return;
  }

  const ctx = canvas.getContext("2d", { willReadFrequently: true });

  const signatureImageInput = document.getElementById("signature-image");
  const clearBtn            = document.getElementById("clear-signature");
  const signatureError      = document.getElementById("signature-error");
  const formError           = document.getElementById("form-error");

  const consentPrivacy      = document.getElementById("consent-privacy");
  const consentDelegation   = document.getElementById("consent-delegation");

  const emailSubjectInput   = document.getElementById("email-subject");

  // ===== 1) 그리기 상태 =====
  let isDrawing = false;
  let lastX = 0, lastY = 0;
  let hasSignature = false;

  // iOS/모바일에서 리사이즈(주소창/키보드)로 캔버스가 자주 리셋됨 → 복원용 스냅샷
  let snapshotDataURL = "";

  // ===== 2) 캔버스 크기 설정 + (중요) 리사이즈 시 기존 서명 복원 =====
  function setCanvasSizePreserve() {
    // 1) 현재 내용을 임시 저장
    if (hasSignature) {
      try {
        snapshotDataURL = canvas.toDataURL("image/png");
      } catch (e) {
        // cross-origin 없음. 실패해도 진행
      }
    }

    // 2) 새 크기 적용(레티나 대응)
    const rect = canvas.getBoundingClientRect();
    const cssW = Math.max(1, rect.width);
    const cssH = 220;
    const ratio = window.devicePixelRatio || 1;

    canvas.width  = Math.floor(cssW * ratio);
    canvas.height = Math.floor(cssH * ratio);

    // 좌표계는 CSS 픽셀 기준으로 쓰고 싶으니 transform으로 맞춤
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

    // 3) 복원
    if (hasSignature && snapshotDataURL) {
      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, cssW, cssH);
        ctx.drawImage(img, 0, 0, cssW, cssH);
      };
      img.src = snapshotDataURL;
    } else {
      ctx.clearRect(0, 0, cssW, cssH);
    }
  }

  // 최초 1회
  setCanvasSizePreserve();

  // 리사이즈/방향전환
  window.addEventListener("resize", () => {
    // 주소창 애니메이션 때문에 연속 호출될 수 있어 rAF로 안정화
    window.requestAnimationFrame(setCanvasSizePreserve);
  });

  // ResizeObserver(모바일에서 레이아웃 변동이 잦을 때)
  if (window.ResizeObserver) {
    const ro = new ResizeObserver(() => {
      window.requestAnimationFrame(setCanvasSizePreserve);
    });
    ro.observe(canvas);
  }

  // ===== 3) 좌표 계산 (터치/마우스 공통) =====
  function getPointFromEvent(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches && e.touches[0]) {
      return {
        x: e.touches[0].clientX - rect.left,
        y: e.touches[0].clientY - rect.top
      };
    }
    return {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top
    };
  }

  // ===== 4) 그리기 로직 =====
  function start(e) {
    // 스크롤 방지(특히 모바일)
    if (e.cancelable) e.preventDefault();

    const p = getPointFromEvent(e);
    isDrawing = true;
    hasSignature = true;
    lastX = p.x;
    lastY = p.y;

    // 서명 시작 시 에러 숨김
    if (signatureError) signatureError.style.display = "none";
  }

  function move(e) {
    if (!isDrawing) return;
    if (e.cancelable) e.preventDefault();

    const p = getPointFromEvent(e);

    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";

    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();

    lastX = p.x;
    lastY = p.y;

    // 스냅샷 갱신(리사이즈 복원용)
    // 너무 자주 하면 무거우니 requestAnimationFrame 수준으로만 저장
    // (간단히 move 끝에서 저장)
    try { snapshotDataURL = canvas.toDataURL("image/png"); } catch (e2) {}
  }

  function end(e) {
    if (e && e.cancelable) e.preventDefault();
    isDrawing = false;
  }

  // 마우스
  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  canvas.addEventListener("mouseup", end);
  canvas.addEventListener("mouseleave", end);

  // 터치 (passive: false 필수 → preventDefault 가능)
  canvas.addEventListener("touchstart", start, { passive: false });
  canvas.addEventListener("touchmove", move, { passive: false });
  canvas.addEventListener("touchend", end, { passive: false });
  canvas.addEventListener("touchcancel", end, { passive: false });

  // ===== 5) 서명 지우기 =====
  if (clearBtn) {
    clearBtn.addEventListener("click", () => {
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, rect.width, 220);
      hasSignature = false;
      snapshotDataURL = "";
      if (signatureError) signatureError.style.display = "none";
    });
  }

  // ===== 6) 체크박스 클릭 시 서명이 지워지는 문제 방지 =====
  // 원인: 모바일에서 레이아웃 재계산/주소창 변화로 canvas resize가 발생 → 리셋
  // 해결: 체크박스 변경 직전 현재 상태를 snapshot으로 저장 + 다음 프레임에 복원
  function preserveOnUIChange() {
    if (!hasSignature) return;
    try { snapshotDataURL = canvas.toDataURL("image/png"); } catch (e) {}
    // 다음 프레임에 복원(레이아웃 변화 후)
    requestAnimationFrame(() => {
      if (!hasSignature || !snapshotDataURL) return;
      const img = new Image();
      img.onload = () => {
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, rect.width, 220);
        ctx.drawImage(img, 0, 0, rect.width, 220);
      };
      img.src = snapshotDataURL;
    });
  }

  if (consentPrivacy)    consentPrivacy.addEventListener("change", preserveOnUIChange);
  if (consentDelegation) consentDelegation.addEventListener("change", preserveOnUIChange);

  // ===== 7) 제출 시 처리 =====
  function exportSignatureCompressed() {
    // PNG → JPEG로 변환해 base64 폭발 방지
    const rect = canvas.getBoundingClientRect();
    const srcW = Math.floor(rect.width);
    const srcH = 220;

    // 너무 큰 경우 리사이즈
    const maxW = 800;
    const outW = Math.min(srcW, maxW);
    const outH = Math.floor(outW * (srcH / srcW));

    const out = document.createElement("canvas");
    out.width = outW;
    out.height = outH;
    const octx = out.getContext("2d");

    // 흰 배경
    octx.fillStyle = "#ffffff";
    octx.fillRect(0, 0, outW, outH);

    // 원본 캔버스 내용 그리기 (레티나 캔버스이므로 drawImage는 canvas 전체를 대상으로 OK)
    octx.drawImage(canvas, 0, 0, outW, outH);

    return out.toDataURL("image/jpeg", 0.82);
  }

  form.addEventListener("submit", function (e) {
    // 에러 초기화
    if (formError) {
      formError.textContent = "";
      formError.style.display = "none";
    }
    if (signatureError) signatureError.style.display = "none";

    // 제목 동적 세팅(메일 제목 변수 치환 문제 방지: JS로 직접 값 넣기)
    if (emailSubjectInput) {
      const name = (document.querySelector('input[name="full_name"]')?.value || "").trim();
      const dong = (document.querySelector('input[name="dong"]')?.value || "").trim();
      const ho   = (document.querySelector('input[name="ho"]')?.value || "").trim();
      emailSubjectInput.value = `힐스테이트 메디알레 전자 위임장 제출 - ${name} (${dong}동 ${ho}호)`;
    }

    // 동의 체크
    if (!consentPrivacy?.checked || !consentDelegation?.checked) {
      e.preventDefault();
      if (formError) {
        formError.textContent = "모든 동의사항에 체크해 주세요.";
        formError.style.display = "block";
      } else {
        alert("모든 동의사항에 체크해 주세요.");
      }
      return;
    }

    // 서명 체크
    if (!hasSignature) {
      e.preventDefault();
      if (signatureError) {
        signatureError.style.display = "block";
      } else {
        alert("서명을 남겨주세요.");
      }
      return;
    }

    // 서명 이미지 저장
    if (signatureImageInput) {
      signatureImageInput.value = exportSignatureCompressed();
    }
  });

})();
                    </script>
